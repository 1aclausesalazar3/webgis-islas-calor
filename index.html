<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>WebGIS ‚Äì Islas de calor urbano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  /> 
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
    }
    header {
      padding: 0.75rem 1rem;
      background:#000;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap:1rem;
      flex-wrap: wrap;
    }
    h1 {
      font-size:1rem;
      margin:0;
    }
    header p {
      margin:0;
      font-size:0.85rem;
      opacity:0.8;
    }
    .header-left {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.7rem;
      background:#222;
      margin-top:4px;
    }
    .btn-aportar {
      background:#22c55e;
      padding:8px 14px;
      border-radius:999px;
      font-weight:bold;
      border:none;
      cursor:pointer;
      color:#022c22;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      white-space: nowrap;
    }
    .btn-aportar:hover {
      background:#16a34a;
    }
    #map {
      height: calc(100vh - 90px);
      width: 100%;
    }
    #status {
      font-size:0.8rem;
      padding:0.25rem 1rem 0.5rem 1rem;
      background:#050505;
      border-top:1px solid #222;
      color:#a3a3a3;
    }
    #status strong {
      color:#e5e5e5;
    }
    #status span.error {
      color:#f97373;
    }
  </style>
</head>

<body>
<header>
  <div class="header-left">
    <h1>WebGIS ‚Äì Islas de calor urbano</h1>
    <p>Visor de reportes ciudadanos de temperatura en Chile (solo puntos aprobados).</p>
    <span class="pill">Colores seg√∫n temperatura reportada</span>
  </div>

  <!-- Bot√≥n que abre el formulario en otra pesta√±a -->
  <a class="btn-aportar" href="formulario.html" target="_blank" rel="noopener">
    üìù Aportar medici√≥n
  </a>
</header>

<div id="status">Cargando datos desde Firebase‚Ä¶</div>
<div id="map"></div>

<script>
  // ==============
  // 1) Firebase
  // ==============
  const firebaseConfig = {
    apiKey: "AIzaSyDxLCrOsxUPRBaD3SHwOpVQLWGxXZ971BU",
    authDomain: "islas-de-calor-webgis.firebaseapp.com",
    databaseURL: "https://islas-de-calor-webgis-default-rtdb.firebaseio.com",
    projectId: "islas-de-calor-webgis",
    storageBucket: "islas-de-calor-webgis.appspot.com",
    messagingSenderId: "368570253562",
    appId: "1:368570253562:web:5607156874c0139a090fcf",
    measurementId: "G-1FBX7WE39F"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ==============
  // 2) Mapa
  // ==============
  const map = L.map('map').setView([-33.5, -70.7], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const markersLayer = L.layerGroup().addTo(map);
  const statusEl = document.getElementById('status');

  function colorPorTemperatura(t) {
    const temp = parseFloat(t);
    if (isNaN(temp)) return '#aaaaaa';
    if (temp < 18)  return '#3b82f6'; // azul
    if (temp < 25)  return '#22c55e'; // verde
    if (temp < 30)  return '#f97316'; // naranjo
    return '#ef4444';               // rojo
  }

  // ==============
  // 3) Leer datos
  // ==============
  db.ref('reportes').on('value', (snapshot) => {
    markersLayer.clearLayers();
    const boundsPoints = [];
    let total = 0;
    let dibujados = 0;

    snapshot.forEach(child => {
      const r = child.val();
      total++;

      // Aceptar aprobado como booleano true o texto "true"
      const aprobado = (r.aprobado === true || r.aprobado === "true");
      if (!aprobado) return;

      const lat = parseFloat(r.lat);
      const lng = parseFloat(r.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      const temp = r.temp ?? '';
      const hum  = r.hum ?? '';
      const perc = r.percepcion ?? '';
      const sup  = r.superficie ?? '';
      const sombra = r.sombra ?? '';
      const esViv = r.es_vivienda ?? '';
      const matViv = r.material_vivienda ?? '';
      const desc = r.descripcion ?? '';
      const fecha = r.fechaHora ?? '';
      const sens = r.sensacion ?? '';

      const color = colorPorTemperatura(temp);

      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: '#000',
        weight: 1,
        fillColor: color,
        fillOpacity: 0.9
      }).addTo(markersLayer);

      const popupHtml = `
        <strong>Temperatura:</strong> ${temp} ¬∞C<br>
        <strong>Sensaci√≥n t√©rmica:</strong> ${sens} ¬∞C<br>
        <strong>Humedad:</strong> ${hum} %<br>
        <strong>Percepci√≥n t√©rmica:</strong> ${perc}<br>
        <strong>Fecha y hora:</strong> ${fecha}<br>
        <hr>
        <strong>Entorno:</strong> ${esViv || '-'}<br>
        <strong>Material vivienda:</strong> ${matViv || '-'}<br>
        <strong>Tipo de superficie:</strong> ${sup || '-'}<br>
        <strong>Nivel de sombra:</strong> ${sombra || '-'}<br>
        <hr>
        <strong>Descripci√≥n:</strong><br>
        <span style="font-size:0.85rem;">${desc || '(sin descripci√≥n)'}</span>
      `;

      marker.bindPopup(popupHtml);
      boundsPoints.push([lat, lng]);
      dibujados++;
    });

    if (dibujados > 0) {
      map.fitBounds(boundsPoints, { padding: [40, 40] });
      statusEl.innerHTML =
        `Reportes totales en la base: <strong>${total}</strong> ¬∑ ` +
        `Mostrando aprobados: <strong>${dibujados}</strong>.`;
    } else {
      statusEl.innerHTML =
        `Reportes totales en la base: <strong>${total}</strong> ¬∑ ` +
        `No hay puntos aprobados o con coordenadas v√°lidas.`;
    }
  }, (error) => {
    console.error('Error leyendo Firebase:', error);
    statusEl.innerHTML =
      `<span class="error">Error al leer datos de Firebase: ${error.code || error.message}</span>`;
  });
</script>

</body>
</html>

